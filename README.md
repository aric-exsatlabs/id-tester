# ID Tester

一个用于测试和比较不同 UID 生成方案性能的工具，支持 nanoid16、ULID 和 KSUID。

## 快速开始

### 运行压力测试

```bash
go run cmd/uidstress/main.go -schemes=nanoid16,ulid,ksuid -scale=50000000 -chunk=1000000
```

### 参数说明

- `-schemes`: 要测试的方案列表，用逗号分隔（默认: `nanoid16,ulid,ksuid`）
- `-scale`: 每个方案要生成的 ID 数量（默认: `50000000`）
- `-chunk`: 每个 chunk 的 ID 数量（默认: `1000000`）
- `-tempdir`: 临时文件的基础目录（默认: 系统临时目录）
- `-keep`: 完成后保留临时数据（默认: `false`）
- `-log-interval`: 进度日志间隔（默认: `1000000`）
- `-mem-guard`: 最小空闲内存（MB），用于资源估算（默认: `512`）
- `-verbose`: 启用详细日志（默认: `false`）
- `-bytes-per-id`: 每个 ID 的近似字节数，用于资源估算（默认: `64`）
- `-disk-factor`: 磁盘安全系数乘数（默认: `1.25`）

## 项目结构

```text
id-tester/
├── cmd/
│   └── uidstress/        # 压力测试命令行工具
│       └── main.go
├── internal/
│   └── tools/
│       ├── ksuid.go      # KSUID 生成器
│       ├── nanoid.go     # nanoid16 生成器
│       ├── ulid.go       # ULID 生成器
│       ├── uid_comparison_test.go  # 单元测试
│       └── uidstress/    # 压力测试核心逻辑
│           └── stress.go
├── go.mod
└── README.md
```

## 依赖

- `github.com/matoous/go-nanoid/v2` - nanoid 实现
- `github.com/oklog/ulid/v2` - ULID 实现
- `github.com/segmentio/ksuid` - KSUID 实现
- `github.com/shirou/gopsutil/v4` - 系统资源监控

## 测试结果

### 综合结论

1. **性能最优：ULID** - 在所有测试场景中都表现最佳，生成速度最快
2. **唯一性保证：** 所有三种方案在测试中都达到了 100% 的唯一性，无重复 ID
3. **可扩展性：** 所有方案都能稳定处理大规模 ID 生成任务（1 亿个 ID）

### 单元测试与基准测试

#### ID 长度验证

所有方案生成的 ID 长度符合预期：

- **NanoID(16)**: 16 字符
- **ULID**: 26 字符
- **KSUID**: 27 字符

✅ 所有测试通过

#### 唯一性测试 (100 万个 ID)

| Scheme   | 耗时    | 唯一 ID 数量 | 重复数 | 状态 |
|----------|---------|--------------|--------|------|
| nanoid16 | 0.79s   | 1,000,000    | 0      | ✅   |
| ulid     | 0.28s   | 1,000,000    | 0      | ✅   |
| ksuid    | 0.80s   | 1,000,000    | 0      | ✅   |

**结果：** 所有方案在生成 100 万个 ID 时都保持了 100% 的唯一性，无重复。

#### 并发安全性测试 (10 万个 ID, 100 个 goroutine)

| Scheme   | 耗时    | 唯一 ID 数量 | 重复数 | 状态 |
|----------|---------|--------------|--------|------|
| nanoid16 | 0.19s   | 100,000      | 0      | ✅   |
| ulid     | 0.04s   | 100,000      | 0      | ✅   |
| ksuid    | 0.13s   | 100,000      | 0      | ✅   |

**结果：** 所有方案在并发场景下（100 个 goroutine）都保持了 100% 的唯一性，无重复。

#### 基准测试结果

##### 单线程性能基准

| Scheme   | 操作耗时    | 内存分配 | 分配次数 | 相对性能 |
|----------|-------------|----------|----------|----------|
| ulid     | 138.8 ns/op | 48 B/op  | 2 allocs | ⭐⭐⭐⭐⭐ |
| nanoid16 | 627.4 ns/op | 296 B/op | 4 allocs | ⭐⭐⭐    |
| ksuid    | 782.6 ns/op | 32 B/op  | 1 allocs | ⭐⭐     |

**分析：**

- **ULID** 最快：138.8 ns/op，比 nanoid16 快约 4.5 倍，比 KSUID 快约 5.6 倍
- **KSUID** 内存占用最少：32 B/op，但生成速度最慢
- **nanoid16** 内存占用最大：296 B/op，性能中等

##### 并发性能基准

| Scheme   | 操作耗时     | 内存分配 | 分配次数 | 相对性能 |
|----------|--------------|----------|----------|----------|
| ulid     | 280.1 ns/op  | 48 B/op  | 2 allocs | ⭐⭐⭐⭐⭐ |
| ksuid    | 1021 ns/op   | 32 B/op  | 1 allocs | ⭐⭐⭐    |
| nanoid16 | 1101 ns/op   | 296 B/op | 4 allocs | ⭐⭐     |

**分析：**

- **ULID** 在并发场景下仍然最快：280.1 ns/op，比 KSUID 快约 3.6 倍，比 nanoid16 快约 3.9 倍
- 并发场景下所有方案的性能都有所下降，但 ULID 的下降幅度最小
- **KSUID** 在并发场景下性能超过 nanoid16

**测试环境：**

- **操作系统**: macOS (darwin 25.1.0)
- **架构**: arm64
- **CPU**: Apple M1 Pro
- **Go 版本**: 1.25.4

### 大规模压力测试

#### 测试 2: 5 千万个 ID 生成 (50 chunks)

| Scheme   | 耗时      | 生成数量   | 唯一性 | 重复数 |
|----------|-----------|------------|--------|--------|
| nanoid16 | 50.349s   | 50,000,000 | 100%   | 0      |
| ulid     | 18.585s   | 50,000,000 | 100%   | 0      |
| ksuid    | 57.164s   | 50,000,000 | 100%   | 0      |

**性能排名（从快到慢）：**

1. ULID - 18.585s
2. nanoid16 - 50.349s
3. KSUID - 57.164s

**性能分析：**

- ULID 仍然是最快的方案，比 nanoid16 快约 2.71 倍，比 KSUID 快约 3.08 倍
- 在较小规模测试中，ULID 的优势更加明显
- 所有方案都保持了 100% 的唯一性，无重复

#### 测试 1: 1 亿个 ID 生成 (100 chunks)

| Scheme   | 耗时        | 生成数量    | 唯一性 | 重复数 |
|----------|-------------|-------------|--------|--------|
| nanoid16 | 1m47.863s   | 100,000,000 | 100%   | 0      |
| ulid     | 55.157s     | 100,000,000 | 100%   | 0      |
| ksuid    | 2m0.105s    | 100,000,000 | 100%   | 0      |

**性能排名（从快到慢）：**

1. ULID - 55.157s
2. nanoid16 - 1m47.863s
3. KSUID - 2m0.105s

**性能分析：**

- ULID 是最快的方案，比 nanoid16 快约 1.95 倍，比 KSUID 快约 2.18 倍
- nanoid16 的性能介于 ULID 和 KSUID 之间
- 所有方案都保持了 100% 的唯一性，无重复
